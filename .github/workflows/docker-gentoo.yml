name: Docker Image CI

on:   
  workflow_dispatch:
  
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/antonfischl1980/gentoo-ci:main
      options: --privileged
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Init /etc/portage/
      run: |
        rsync -aHDPSv etc/portage/ /etc/portage/

    - name: Setup HomeAssistant repository
      run: |
        mkdir -p /etc/portage/repos.conf/
        echo -en "[HomeAssistantRepository]\nlocation = " >/etc/portage/repos.conf/homeassistant.conf
        pwd -P >> /etc/portage/repos.conf/homeassistant.conf
        cat /etc/portage/repos.conf/*.conf

    - name: Setup portage to ~amd64 and python13
      run: |
        sed -i "s/ACCEPT_KEYWORDS="amd64"/ACCEPT_KEYWORDS=\"~amd64\"/g" /etc/portage/make.conf
        echo -e "*/* PYTHON_TARGETS: -* python3_13\n*/* PYTHON_SINGLE_TARGET: -* python3_13" >> /etc/portage/packae.use/python13.use
        
    - name: emerge-sync
      run: |
        sudo -u portage git -C /var/db/repos/gentoo pull
        emerge --sync
        
    - name: emerge update to python 13
      run: |
        emerge --jobs=4 -Dnuv --autounmask=y --autounmask-continue=y world
        
    - name: emerge home assistant
      run: |
        USE=full emerge --jobs=4 -pv virtual/homeassistant
    
